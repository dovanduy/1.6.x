<?php
	header("Pragma: no-cache");	
	header("Expires: 0");
	header("Last-Modified: " . gmdate("D, d M Y H:i:s") . " GMT");
	header("Cache-Control: no-cache, must-revalidate");
	if(isset($_GET["verbose"])){$GLOBALS["VERBOSE"]=true;ini_set('display_errors', 1);ini_set('error_reporting', E_ALL);ini_set('error_prepend_string',null);ini_set('error_append_string',null);}
	
	
	include_once('ressources/class.templates.inc');
	include_once('ressources/class.ldap.inc');
	include_once('ressources/class.users.menus.inc');
	include_once('ressources/class.groups.inc');
	include_once('ressources/class.artica.inc');
	include_once('ressources/class.ini.inc');
	include_once('ressources/class.squid.inc');
	include_once('ressources/class.system.network.inc');
	include_once('ressources/class.squid.reverse.inc');
	include_once('ressources/class.nginx.interface-tools.php');
	$PRIV=GetPrivs();if(!$PRIV){echo FATAL_ERROR_SHOW_128("{NO_PRIVS}");die();}
	
	if(isset($_POST["edititem"])){item_save();exit;}
	
	if(isset($_GET["group-search"])){group_search();exit;}
	if(isset($_GET["js-group"])){group_js();exit;}
	if(isset($_GET["group-section"])){group_section();exit;}
	if(isset($_GET["group-popup"])){group_popup();exit;}
	if(isset($_POST["editgroupid"])){group_save();exit;}
	if(isset($_GET["delete-group-js"])){group_delete_js();exit;}
	if(isset($_GET["choose-group-js"])){group_choose_js();exit;}
	
	if(isset($_GET["choose-group-unlink-js"])){choose_group_unlink_js();exit;}
	if(isset($_POST["unlink_group"])){choose_group_unlink();exit;}
	
	if(isset($_POST["choose-group"])){group_choose();exit;}
	if(isset($_POST["delete-group"])){group_delete();exit;}
	if(isset($_GET["items-section"])){items_section();exit;}
	if(isset($_GET["items-search"])){items_search();exit;}
	if(isset($_GET["js-item"])){js_item();exit;}
	if(isset($_GET["item-popup"])){item_popup();exit;}
	
	if(isset($_GET["delete-item-js"])){item_delete_js();exit;}
	if(isset($_POST["delete-item"])){item_delete();exit;}
	
	
page();
function group_delete_js(){
	header("content-type: application/x-javascript");
	$tpl=new templates();
	$page=CurrentPageName();
	$ID=$_GET["delete-group-js"];
	$q=new mysql_squid_builder();
	$ligne=mysql_fetch_array($q->QUERY_SQL("SELECT * FROM nginx_exploits_groups WHERE ID='$ID'"));
	$delete=$tpl->javascript_parse_text("{delete}");
	$t=time();
	echo "
var xdelete$t= function (obj) {
	var results=obj.responseText;
	if(results.length>3){alert(results);}
	$('#NGINX_ANTI_EXPLOITS').flexReload();
}

function delete$t(){
	if(!confirm('$delete {$ligne["groupname"]} ?')){return;}
	var XHR = new XHRConnection();
	XHR.appendData('delete-group','$ID');
	XHR.sendAndLoad('$page', 'POST',xdelete$t);
}
	
	
delete$t();";


}
function group_delete(){
	$q=new mysql_squid_builder();
	$q->QUERY_SQL("DELETE FROM nginx_exploits_items WHERE groupid={$_POST["delete-group"]}");
	if(!$q->ok){echo $q->mysql_error;return;}
	$q->QUERY_SQL("DELETE FROM nginx_exploits_groups WHERE ID={$_POST["delete-group"]}");
	if(!$q->ok){echo $q->mysql_error;return;}
	$q->QUERY_SQL("DELETE FROM nginx_exploits WHERE groupid={$_POST["delete-group"]}");
	if(!$q->ok){echo $q->mysql_error;return;}

}
function js_item(){
	header("content-type: application/x-javascript");
	$tpl=new templates();
	$page=CurrentPageName();
	$q=new mysql_squid_builder();
	$ligne=mysql_fetch_array($q->QUERY_SQL("SELECT * FROM nginx_exploits_groups WHERE ID='{$_GET["ID"]}'"));
	$ID=$_GET["ID"];
	if($ID==0){
		$title="{anti_exploits}::{new_item}::{$ligne["groupname"]}::{$_GET["servername"]}";
	}else{
		$title="{anti_exploits}::{$ligne["groupname"]}::{$_GET["servername"]}";
	}
	$title=$tpl->javascript_parse_text($title);
	echo "YahooWin6(890,'$page?item-popup=yes&servername={$_GET["servername"]}&ID=$ID&groupid={$_GET["groupid"]}','$title')";


}
function item_delete_js(){
	header("content-type: application/x-javascript");
	$tpl=new templates();
	$page=CurrentPageName();
	$ID=$_GET["delete-item-js"];
	$q=new mysql_squid_builder();
	$ligne=mysql_fetch_array($q->QUERY_SQL("SELECT * FROM nginx_exploits_items WHERE ID='$ID'"));
	$delete=$tpl->javascript_parse_text("{delete}");
	$t=time();
	$groupid=$ligne["groupid"];
	$ligne["pattern"]=str_replace("'", "`", $ligne["pattern"]);
	echo "
var xdelete$t= function (obj) {
	var results=obj.responseText;
	if(results.length>3){alert(results);return;}
	$('#NGINX_ANTI_EXPLOITS').flexReload();
	$('#NGINX_ITEMS_SECTION_{$groupid}').flexReload();
}

function delete$t(){
	if(!confirm('$delete \"{$ligne["pattern"]}\" ?')){return;}
	var XHR = new XHRConnection();
	XHR.appendData('delete-item','$ID');
	XHR.sendAndLoad('$page', 'POST',xdelete$t);
}
delete$t();";
}
function item_delete(){
	$q=new mysql_squid_builder();
	$q->QUERY_SQL("DELETE FROM nginx_exploits_items WHERE ID='{$_POST["delete-item"]}'");
	if(!$q->ok){echo $q->mysql_error;return;}
}
function choose_group_unlink_js(){
	header("content-type: application/x-javascript");
	$tpl=new templates();
	$page=CurrentPageName();
	$zmd5=$_GET["choose-group-unlink-js"];
	$q=new mysql_squid_builder();
	$ligne=mysql_fetch_array($q->QUERY_SQL("SELECT * FROM nginx_exploits WHERE zmd5='$zmd5'"));
	$groupid=$ligne["groupid"];
	
	$ligne=mysql_fetch_array($q->QUERY_SQL("SELECT * FROM nginx_exploits_groups WHERE ID='$groupid'"));
	$groupname=utf8_encode($ligne["groupname"]);
	
	$delete=$tpl->javascript_parse_text("{unlink}");
	
	$t=time();
	echo "

var xdelete$t= function (obj) {
	var results=obj.responseText;
	if(results.length>3){alert(results);return;}
	$('#NGINX_ANTI_EXPLOITS').flexReload();
}

function delete$t(){
	if(!confirm('$delete $groupname ?')){return;}
	var XHR = new XHRConnection();
	XHR.appendData('unlink_group','$zmd5');
	XHR.appendData('servername','{$_GET["servername"]}');
	XHR.sendAndLoad('$page', 'POST',xdelete$t);
}


delete$t();";
}

function choose_group_unlink(){
	$q=new mysql_squid_builder();
	$zmd5=$_POST["unlink_group"];
	$q->QUERY_SQL("DELETE FROM nginx_exploits WHERE zmd5='$zmd5'");
}

function group_choose_js(){
	header("content-type: application/x-javascript");
	$tpl=new templates();
	$page=CurrentPageName();
	$ID=$_GET["choose-group-js"];
	$q=new mysql_squid_builder();
	$ligne=mysql_fetch_array($q->QUERY_SQL("SELECT * FROM nginx_exploits_groups WHERE ID='$ID'"));
	$delete=$tpl->javascript_parse_text("{choose}");
	$t=time();
	echo "
var xdelete$t= function (obj) {
	var results=obj.responseText;
	if(results.length>3){alert(results);}
	$('#NGINX_ANTI_EXPLOITS').flexReload();
}

function delete$t(){
	if(!confirm('$delete {$ligne["groupname"]} / {$_GET["servername"]}')){return;}
	var XHR = new XHRConnection();
	XHR.appendData('choose-group','$ID');
	XHR.appendData('servername','{$_GET["servername"]}');
	XHR.sendAndLoad('$page', 'POST',xdelete$t);
}


delete$t();";
}
function group_choose(){
	$zmd5=md5("{$_POST["choose-group"]}{$_POST["servername"]}");
	$sql="INSERT IGNORE INTO nginx_exploits (zmd5,groupid,servername) VALUES('$zmd5','{$_POST["choose-group"]}','{$_POST["servername"]}')";
	$q=new mysql_squid_builder();
	$q->QUERY_SQL($sql);
	if(!$q->ok){echo $q->mysql_error;return;}
}

function group_js(){
	header("content-type: application/x-javascript");
	$tpl=new templates();
	$page=CurrentPageName();
	$ID=$_GET["ID"];
	if($ID==0){
		$title="{anti_exploits}::{new_group}::{$_GET["servername"]}";
	}else{
		$q=new mysql_squid_builder();
		$ligne=mysql_fetch_array($q->QUERY_SQL("SELECT * FROM nginx_exploits_groups WHERE ID='{$_GET["ID"]}'"));
		$title="{anti_exploits}::{group2}:{$ligne["groupname"]}";
	}
	$title=$tpl->javascript_parse_text($title);
	echo "YahooWin5(920,'$page?group-section=yes&servername={$_GET["servername"]}&ID=$ID','$title')";

}
function group_section(){
	
	$tpl=new templates();
	$page=CurrentPageName();
	$ID=$_GET["ID"];
	
	$array["group"]="{new_group}";
	
	if($ID>0){
		$q=new mysql_squid_builder();
		$ligne=mysql_fetch_array($q->QUERY_SQL("SELECT groupname FROM nginx_exploits_groups WHERE ID='{$_GET["ID"]}'"));
		$array["group"]=$ligne["groupname"];
		$array["items"]="{items}";
		
	}
	
	
	$fontsize=24;
	while (list ($num, $ligne) = each ($array) ){
	
		if($num=="group"){
			$tab[]= $tpl->_ENGINE_parse_body("<li><a href=\"$page?group-popup=yes&ID=$ID&servername={$_GET["servername"]}\" style='font-size:{$fontsize}px'><span>$ligne</span></a></li>\n");
			continue;
		}
		if($num=="items"){
			$tab[]= $tpl->_ENGINE_parse_body("<li><a href=\"$page?items-section=yes&groupid=$ID&servername={$_GET["servername"]}\" style='font-size:{$fontsize}px'><span>$ligne</span></a></li>\n");
			continue;
		}
	
		$tab[]="<li style='font-size:{$fontsize}px'><a href=\"$page?$num=yes&servername=$servername_enc\"><span >$ligne</span></a></li>\n";
			
	}
	
	echo build_artica_tabs($tab, "main_nginx_exploit_group_section");	
	
}

function item_popup(){
	$ID=$_GET["ID"];
	$q=new mysql_squid_builder();
	$title="{new_item}";
	$bt="{add}";
	$t=time();
	$tpl=new templates();
	$page=CurrentPageName();
	$ligne=mysql_fetch_array($q->QUERY_SQL("SELECT * FROM nginx_exploits_groups WHERE ID='{$_GET["groupid"]}'"));
	$groupname=$ligne["groupname"];
	$ligne["enabled"]=1;

	if($ID>0){

		$ligne=mysql_fetch_array($q->QUERY_SQL("SELECT * FROM nginx_exploits_items WHERE ID='$ID'"));
		$bt="{apply}";
		$title="$groupname::{{$ligne["token"]}}";

	}

	$array["http_user_agent"]="{http_user_agent}";
	$array["query_string"]="{query_string}";
	
	$html[]="<div style='width:98%' class=form>";
	$html[]="<table style='width:100%'>";
	$html[]="<tr style='height:75px'><td colspan=2 style='font-size:36px;margin-bottom:40px'>$title</td></tr>";
	$html[]=Field_checkbox_table("enabled-$t","{enabled}",$ligne["enabled"],26);
	$html[]=Field_checkbox_table("reverse-$t","{reverse}",$ligne["reverse"],26);
	$html[]=Field_list_table("token-$t", "{token}", $ligne["token"],26,$array);
	$html[]=Field_area_table("pattern-$t", "{pattern}",$ligne["pattern"],26,null,200);
	$html[]=Field_button_table_autonome($bt,"ItemSubmit$t",30);
	$html[]="</table>";
	$html[]="</div>
	<script>
var xItemSubmit$t= function (obj) {
	var results=obj.responseText;
	if(results.length>3){alert(results);return;}
	$('#NGINX_ANTI_EXPLOITS').flexReload();
	$('#NGINX_ITEMS_SECTION_{$_GET["groupid"]}').flexReload();
	var ID=$ID;
	if(ID==0){ YahooWin6Hide();}
}
	
	
function ItemSubmit$t(){
	var XHR = new XHRConnection();
	XHR.appendData('edititem','$ID');
	XHR.appendData('groupid','{$_GET["groupid"]}');
	XHR.appendData('pattern',encodeURIComponent(document.getElementById('pattern-$t').value));
	XHR.appendData('token',document.getElementById('token-$t').value);
	if(document.getElementById('reverse-$t').checked){ XHR.appendData('reverse',1); }else{ XHR.appendData('reverse',0); }
	XHR.sendAndLoad('$page', 'POST',xItemSubmit$t);
}
</script>";
	echo $tpl->_ENGINE_parse_body(@implode("\n", $html));

}

function item_save(){
	$q=new mysql_squid_builder();

	if(!$q->FIELD_EXISTS("nginx_exploits_items", "reverse")){
		$q->QUERY_SQL("ALTER TABLE `nginx_exploits_items` ADD `reverse` smallint(1) NOT NULL DEFAULT 0, ADD INDEX ( `reverse`)");
	}

	$ID=$_POST["edititem"];
	$_POST["pattern"]=mysql_escape_string2(url_decode_special_tool($_POST["pattern"]));
	if($ID==0){
		$sql="INSERT IGNORE INTO nginx_exploits_groups (`groupname`)
		VALUES ('{$_POST["groupname"]}')";
		$q->QUERY_SQL($sql);
		if(!$q->ok){echo $q->mysql_error;return;}
		$ID=$q->last_id;
		$sql="INSERT IGNORE INTO nginx_exploits_items (`groupid`,`enabled`,`pattern`,`token`,`reverse`) VALUES
		('{$_POST["groupid"]}','{$_POST["enabled"]}','{$_POST["pattern"]}','{$_POST["token"]}','{$_POST["reverse"]}')";
		$q->QUERY_SQL($sql);
		if(!$q->ok){echo $q->mysql_error;return;}
		return;
	}
		$q->QUERY_SQL("UPDATE nginx_exploits_items SET `pattern`='{$_POST["pattern"]}',`token`='{$_POST["token"]}',`reverse`='{$_POST["reverse"]}',
		`enabled`='{$_POST["enabled"]}' WHERE ID=$ID");
		if(!$q->ok){echo $q->mysql_error;return;}
		}
function group_popup(){
	$ID=$_GET["ID"];
	$q=new mysql_squid_builder();
	$page=CurrentPageName();
	$tpl=new templates();
	$title="{new_group}";
	$bt="{add}";
	
	$t=time();
	if(!$q->TABLE_EXISTS("nginx_exploits_groups")){
		$sql="CREATE TABLE IF NOT EXISTS `nginx_exploits_groups` (
			  `ID` INT NOT NULL AUTO_INCREMENT,
			  `groupname` CHAR(255)  NOT NULL,
			  PRIMARY KEY (`ID`),
			  KEY `groupname` (`groupname`)
			)  ENGINE = MYISAM;";
		if(!$q->QUERY_SQL($sql)){echo $q->mysql_error_html();}
	}

	
	$sock=new sockets();


	if($ID>0){
		$ligne=mysql_fetch_array($q->QUERY_SQL("SELECT * FROM nginx_exploits_groups WHERE ID='$ID'"));
		$bt="{apply}";
		$title=utf8_encode("{$ligne["groupname"]}");

	}

	$html[]="<div style='width:98%' class=form>";
	$html[]="<table style='width:100%'>";
	$html[]="<tr style='height:75px'><td colspan=2 style='font-size:36px;margin-bottom:40px'>$title</td></tr>";
	
	$html[]=Field_checkbox_table("addef-$t","{add_defaults}",0,26);
	$html[]=Field_text_table("groupname-$t","{groupname}",$ligne["groupname"],26,null,450);
	$html[]=Field_button_table_autonome($bt,"Submit$t",30);
	$html[]="</table>";
	$html[]="</div>
<script>
	var xSubmit$t= function (obj) {
		var results=obj.responseText;
		if(results.length>3){alert(results);}
		$('#NGINX_ANTI_EXPLOITS').flexReload();
		var ID=$ID;
		if(ID==0){ YahooWin5Hide();}
		
	}


	function Submit$t(){
		var XHR = new XHRConnection();	
		XHR.appendData('editgroupid','$ID');
		XHR.appendData('servername','{$_GET["servername"]}');
		XHR.appendData('groupname',encodeURIComponent(document.getElementById('groupname-$t').value));
		if(document.getElementById('addef-$t').checked){ XHR.appendData('addef',1); }else{ XHR.appendData('addef',0); }
		XHR.sendAndLoad('$page', 'POST',xSubmit$t);	
	}
</script>";
	
echo $tpl->_ENGINE_parse_body(@implode("\n", $html));
}
function group_save(){
	$_POST["groupname"]=mysql_escape_string2(url_decode_special_tool($_POST["groupname"]));
	$q=new mysql_squid_builder();
	$ID=$_POST["editgroupid"];
	if($ID==0){
		$sql="INSERT IGNORE INTO nginx_exploits_groups (`groupname`)
		VALUES ('{$_POST["groupname"]}')";
		$q->QUERY_SQL($sql);
		if(!$q->ok){echo $q->mysql_error;return;}
		$ID=$q->last_id;
		if($_POST["servername"]<>null){
		$zmd5=md5("$ID{$_POST["servername"]}");
		$sql="INSERT IGNORE INTO nginx_exploits (`zmd5`,`groupid`,`servername`)
		VALUES ('$zmd5',$ID,'{$_POST["servername"]}')";
		$q->QUERY_SQL($sql);
		if(!$q->ok){echo $q->mysql_error;return;}
		}

		if($_POST["addef"]==1){
				group_defaults($ID);
		}

		return;
	}

	$q->QUERY_SQL("UPDATE nginx_exploits_groups SET `groupname`='{$_POST["groupname"]}',
	`enabled`='{$_POST["enabled"]}' WHERE ID=$ID");
	if(!$q->ok){echo $q->mysql_error;return;}
	}
function group_defaults($ID){
		$f[]="union.*select.*\(";
		$f[]="union.*all.*select.*";
		$f[]="concat.*\(";
		$f[]="[a-zA-Z0-9_]=http://";
		$f[]="[a-zA-Z0-9_]=(\.\.//?)+";
		$f[]="[a-zA-Z0-9_]=/([a-z0-9_.]//?)+";
		$f[]="(<|%3C).*script.*(>|%3E)";
		$f[]="GLOBALS(=|\[|\%[0-9A-Z]{0,2)";
		$f[]="_REQUEST(=|\[|\%[0-9A-Z]{0,2)";
		$f[]="proc/self/environ";
		$f[]="mosConfig_[a-zA-Z_]{1,21(=|\%3D)";
		$f[]="base64_(en|de)code\(.*\)";
		$f[]="\b(ultram|unicauca|valium|viagra|vicodin|xanax|ypxaieo)\b";
		$f[]="\b(erections|hoodia|huronriveracres|impotence|levitra|libido)\b";
		$f[]="\b(ambien|blue\spill|cialis|cocaine|ejaculation|erectile)\b";
		$f[]="\b(lipitor|phentermin|pro[sz]ac|sandyauer|tramadol|troyhamby)\b";
	
	

	
		$prefix="INSERT IGNORE INTO nginx_exploits_items (`groupid`,`enabled`,`pattern`,`token`) VALUES";
		while (list ($head, $pattern) = each ($f) ){
			$n[]="($ID,1,'".mysql_escape_string2($pattern)."','query_string')";
	
		}
	
	
		$f=array();
		$f[]="Wget";
		$f[]="Indy Library";
		$f[]="libwww-perl";
		$f[]="GetRight";
		$f[]="GetWeb!";
		$f[]="Go!Zilla";
		$f[]="Download Demon";
		$f[]="Go-Ahead-Got-It";
		$f[]="TurnitinBot";
		$f[]="GrabNet";
		$f[]="Nmap";
		$f[]="(SBIder/Nutch-1.0-dev|Purebot/1.1|spbot/2.0.2|Toata|Python-urllib)";
	
	
		$q=new mysql_squid_builder();
	
		if(!$q->TABLE_EXISTS("nginx_exploits_items")){
			$sql="CREATE TABLE IF NOT EXISTS `nginx_exploits_items` (
			  `ID` INT NOT NULL AUTO_INCREMENT,
			  `groupid` INT NOT NULL DEFAULT '0',
			  `enabled` smallint(1)  NOT NULL,
			  `pattern` TEXT,
			  `token` CHAR(20)  NOT NULL,
			  PRIMARY KEY (`ID`),
			  KEY `groupid` (`groupid`),
			  KEY `enabled` (`enabled`),
			  KEY `token` (`token`)
			)  ENGINE = MYISAM;";
			$q->QUERY_SQL($sql);
			if(!$q->ok){echo $q->mysql_error;}
		}
	
	
		while (list ($head, $pattern) = each ($f) ){
			$n[]="($ID,1,'".mysql_escape_string2($pattern)."','http_user_agent')";
	
		}
	
		$q->QUERY_SQL($prefix.@implode(",", $n));
		if(!$q->ok){echo $q->mysql_error;}
	}
	
function items_section(){
	$tpl=new templates();
	$sock=new sockets();
	$page=CurrentPageName();
	$tpl=new templates();
	$q=new mysql_squid_builder();
	
	$enabled=$tpl->_ENGINE_parse_body("{enable}");
	$delete=$tpl->_ENGINE_parse_body("{delete}");
	$new_item=$tpl->javascript_parse_text("{new_item}");
	$proxy_child=$tpl->_ENGINE_parse_body("{proxy_child}");
	$delete_this_child=$tpl->javascript_parse_text("{delete_this_child}");
	$apply_params=$tpl->_ENGINE_parse_body("{apply}");
	$title=$tpl->javascript_parse_text("{anti_exploits}::{items}");
	$token=$tpl->javascript_parse_text("{token}");
	$pattern=$tpl->javascript_parse_text("{pattern}");
	$choose=$tpl->javascript_parse_text("{choose}");
	$tt=$_GET["tt"];
	$t=time();
	$about=$tpl->javascript_parse_text("{antiexploits_explain}");
	$about2=$tpl->javascript_parse_text("{about2}");
	$groupid=$_GET["groupid"];
	$html="
		<table class='NGINX_ITEMS_SECTION_{$groupid}' style='display: none' id='NGINX_ITEMS_SECTION_{$groupid}' style='width:99%'></table>
		<script>
		var tmp$t='';
		$(document).ready(function(){
		$('#NGINX_ITEMS_SECTION_{$groupid}').flexigrid({
		url: '$page?items-search=yes&t=$t&servername={$_GET["servername"]}&groupid=$groupid',
		dataType: 'json',
		colModel : [
		{display: '<span style=font-size:18px>$token</span>', name : 'token', width : 193, sortable : true, align: 'left'},
		{display: '<span style=font-size:18px>$pattern</span>', name : 'pattern', width : 555, sortable : false, align: 'left'},
		{display: '&nbsp;', name : 'delete', width : 60, sortable : false, align: 'center'},
	
		],
		buttons : [
		{name: '<strong style=font-size:18px>$new_item</strong>', bclass: 'add', onpress : New$t},
	
		],
		searchitems : [
		{display: '$token', name : 'token'},
		{display: '$pattern', name : 'pattern'},
		],
		sortname: 'pattern',
		sortorder: 'asc',
		usepager: true,
		title: '<strong style=font-size:30px>$title</strong>',
		useRp: true,
		rp: 15,
		showTableToggleBtn: false,
		width: '99%',
		height: 400,
		singleSelect: true
	
	});
	});
function SquidBuildNow$t(){
	Loadjs('nginx.single.progress.php?servername=$servername');
}
	
function New$t(){
	Loadjs('$page?js-item=yes&ID=0&groupid={$_GET["groupid"]}&servername={$_GET["servername"]}')
}
	
	</script>
	";
		echo $html;
	}	
	
function page(){
	$tpl=new templates();
	$sock=new sockets();
	$page=CurrentPageName();
	$tpl=new templates();
	$q=new mysql_squid_builder();
	
	$enabled=$tpl->_ENGINE_parse_body("{enable}");
	$delete=$tpl->_ENGINE_parse_body("{delete}");
	$new_proxy=$tpl->javascript_parse_text("{new_group}");
	$proxy_child=$tpl->_ENGINE_parse_body("{proxy_child}");
	$delete_this_child=$tpl->javascript_parse_text("{delete_this_child}");
	$apply_params=$tpl->_ENGINE_parse_body("{apply}");
	$title=$tpl->javascript_parse_text("{anti_exploits}::{groups}");
	$group=$tpl->javascript_parse_text("{groups}");
	$items=$tpl->javascript_parse_text("{items}");
	$choose=$tpl->javascript_parse_text("{choose}");
	$tt=$_GET["tt"];
	$t=time();
	$about=$tpl->javascript_parse_text("{antiexploits_explain}");
	$about2=$tpl->javascript_parse_text("{about2}");
	$html="
	<table class='NGINX_ANTI_EXPLOITS' style='display: none' id='NGINX_ANTI_EXPLOITS' style='width:99%'></table>
	<script>
	var tmp$t='';
	$(document).ready(function(){
	$('#NGINX_ANTI_EXPLOITS').flexigrid({
	url: '$page?group-search=yes&t=$t&servername={$_GET["servername"]}',
	dataType: 'json',
	colModel : [
	{display: '<span style=font-size:18px>$group</span>', name : 'groupname', width : 622, sortable : true, align: 'left'},
	{display: '<span style=font-size:18px>$items</span>', name : 'a', width : 90, sortable : false, align: 'center'},
	{display: '<span style=font-size:18px>$choose</span>', name : 'b', width : 90, sortable : false, align: 'center'},
	{display: '&nbsp;', name : 'delete', width : 90, sortable : false, align: 'center'},
	
	],
	buttons : [
	{name: '<strong style=font-size:18px>$new_proxy</strong>', bclass: 'add', onpress : New$t},
	{name: '<strong style=font-size:18px>$about2</strong>', bclass: 'Help', onpress : Help$t},
	{separator: true},{name: '<strong style=font-size:18px>$apply_params</strong>', bclass: 'apply', onpress : SquidBuildNow$t},
	
	],
	searchitems : [
	{display: '$group', name : 'groupname'},
	],
	sortname: 'ID',
	sortorder: 'desc',
	usepager: true,
	title: '<strong style=font-size:30px>$title</strong>',
	useRp: true,
	rp: 15,
	showTableToggleBtn: false,
	width: '99%',
	height: 400,
	singleSelect: true
	
	});
	});
function SquidBuildNow$t(){
	Loadjs('nginx.single.progress.php?servername={$_GET["servername"]}');
}
	
function New$t(){
	Loadjs('$page?js-group=yes&ID=0&servername={$_GET["servername"]}')
}

function Help$t(){
	alert('$about');
}
</script>
	";
echo $html;	
}
function group_search(){
	
	$tpl=new templates();
	$MyPage=CurrentPageName();
	$q=new mysql_squid_builder();
	$t=$_GET["t"];
	$search='%';
	$table="nginx_exploits_groups";
	
	
	$FORCE_FILTER=null;
	$page=1;
	
	if($q->COUNT_ROWS($table)==0){json_error_show("No rules....");}
	
	if(isset($_POST["sortname"])){
		if($_POST["sortname"]<>null){
			$ORDER="ORDER BY {$_POST["sortname"]} {$_POST["sortorder"]}";
		}
	}
	
	if (isset($_POST['page'])) {$page = $_POST['page'];}
	
	
	$searchstring=string_to_flexquery();
	
	if($searchstring<>null){
		$sql="SELECT COUNT(*) as TCOUNT FROM `$table` WHERE 1 $FORCE_FILTER $searchstring";
		$ligne=mysql_fetch_array($q->QUERY_SQL($sql));
		$total = $ligne["TCOUNT"];
	
	}else{
		$sql="SELECT COUNT(*) as TCOUNT FROM `$table` WHERE 1 $FORCE_FILTER";
		$ligne=mysql_fetch_array($q->QUERY_SQL($sql));
		$total = $ligne["TCOUNT"];
	}
	
	if (isset($_POST['rp'])) {$rp = $_POST['rp'];}
	
	
	
	$pageStart = ($page-1)*$rp;
	$limitSql = "LIMIT $pageStart, $rp";
	
	$sql="SELECT *  FROM `$table` WHERE 1 $searchstring $FORCE_FILTER $ORDER $limitSql";
	writelogs($sql,__FUNCTION__,__FILE__,__LINE__);
	$results = $q->QUERY_SQL($sql);
	if(!$q->ok){json_error_show("$q->mysql_error");}
	
	
	$data = array();
	$data['page'] = $page;
	$data['total'] = $total;
	$data['rows'] = array();
	if(mysql_num_rows($results)==0){json_error_show("No data....");}
	
	
	
	while ($ligne = mysql_fetch_assoc($results)) {
		$val=0;
		$icon="42-server.png";
		$color="black";
		$checked=null;
		$disable=Field_checkbox("ProxyClient_{$ligne['ID']}", 1,$ligne["enabled"],"EnableDisableProxyClient('{$ligne['ID']}')");
		$delete=imgsimple("delete-42.png",null,"Loadjs('$MyPage?delete-group-js={$ligne["ID"]}&ID={$ligne["ID"]}')");
		$linkjs="Loadjs('$MyPage?js-group=yes&ID={$ligne["ID"]}&servername={$_GET["servername"]}')";
		$ligne["groupname"]=utf8_encode($ligne["groupname"]);
		$choose=imgsimple("checkbox-off-42.png",null,"Loadjs('$MyPage?choose-group-js={$ligne["ID"]}&ID={$ligne["ID"]}&servername={$_GET["servername"]}')");
		
		$ligne2=mysql_fetch_array($q->QUERY_SQL("SELECT COUNT(*) as tcount FROM nginx_exploits_items WHERE groupid='{$ligne["ID"]}'"));
		
		
		$sql="SELECT zmd5 FROM nginx_exploits WHERE groupid='{$ligne["ID"]}' AND servername='{$_GET["servername"]}'";
		$ligne3=mysql_fetch_array($q->QUERY_SQL($sql));
		if($ligne3["zmd5"]<>null){$choose=imgsimple("checkbox-on-42.png",null,"Loadjs('$MyPage?choose-group-unlink-js={$ligne3["zmd5"]}')");}
	
	
	$data['rows'][] = array(
		'id' => "TSC{$ligne['ID']}",
			'cell' => array(
			"<i class='icon-lock'></i><a href=\"javascript:blur();\" OnClick=\"javascript:$linkjs\" style='font-size:26px;color:$color;text-decoration:underline'>{$ligne['groupname']}</span>",
			"<center style='font-size:26px;color:$color;'>{$ligne2["tcount"]}</center>",
			"<center style='margin-top:4px'>$choose</center>",
			"<center style='margin-top:4px'>$delete</center>")
			);
		}
	
	
		echo json_encode($data);	

}
function items_search(){

	$tpl=new templates();
	$MyPage=CurrentPageName();
	$q=new mysql_squid_builder();
	$t=$_GET["t"];
	$search='%';
	$table="nginx_exploits_items";


	$FORCE_FILTER="AND groupid={$_GET["groupid"]}";
	$page=1;

	if($q->COUNT_ROWS($table)==0){json_error_show("No rules....");}

	if(isset($_POST["sortname"])){
		if($_POST["sortname"]<>null){
			$ORDER="ORDER BY {$_POST["sortname"]} {$_POST["sortorder"]}";
		}
	}

	if (isset($_POST['page'])) {$page = $_POST['page'];}


	$searchstring=string_to_flexquery();

	if($searchstring<>null){
		$sql="SELECT COUNT(*) as TCOUNT FROM `$table` WHERE 1 $FORCE_FILTER $searchstring";
		$ligne=mysql_fetch_array($q->QUERY_SQL($sql));
		$total = $ligne["TCOUNT"];

	}else{
		$sql="SELECT COUNT(*) as TCOUNT FROM `$table` WHERE 1 $FORCE_FILTER";
		$ligne=mysql_fetch_array($q->QUERY_SQL($sql));
		$total = $ligne["TCOUNT"];
	}

	if (isset($_POST['rp'])) {$rp = $_POST['rp'];}



	$pageStart = ($page-1)*$rp;
	$limitSql = "LIMIT $pageStart, $rp";

	$sql="SELECT *  FROM `$table` WHERE 1 $searchstring $FORCE_FILTER $ORDER $limitSql";
	writelogs($sql,__FUNCTION__,__FILE__,__LINE__);
	$results = $q->QUERY_SQL($sql);
	if(!$q->ok){json_error_show("$q->mysql_error");}


	$data = array();
	$data['page'] = $page;
	$data['total'] = $total;
	$data['rows'] = array();
	if(mysql_num_rows($results)==0){json_error_show("No data....");}
	$not=$tpl->_ENGINE_parse_body("{is_not}");


	while ($ligne = mysql_fetch_assoc($results)) {
		$val=0;
		$reverse=null;
		if($ligne["reverse"]==1){$reverse="<strong>$not</strong>&nbsp;";}
		$linkjs="Loadjs('$MyPage?js-item=yes&ID={$ligne["ID"]}&groupid={$ligne["groupid"]}&servername={$_GET["servername"]}')";
		$ligne["token"]=$tpl->_ENGINE_parse_body("{{$ligne["token"]}}");
		$delete=imgsimple("delete-24.png",null,"Loadjs('$MyPage?delete-item-js={$ligne["ID"]}&ID={$ligne["ID"]}')");

		$data['rows'][] = array(
				'id' => "TSC{$ligne['ID']}",
				'cell' => array(
						"<a href=\"javascript:blur();\" OnClick=\"javascript:$linkjs\" style='font-size:16px;color:$color;text-decoration:underline'>{$ligne['token']}</span>",
						"<span style='font-size:16px;color:$color;'>$reverse{$ligne["pattern"]}</span>",
						"<center style='margin-top:4px'>$delete</center>")
		);
	}


	echo json_encode($data);

}


function GetPrivs(){
	$NGNIX_PRIVS=$_SESSION["NGNIX_PRIVS"];
	$users=new usersMenus();
	if($users->AsSystemWebMaster){return true;}
	if($users->AsSquidAdministrator){return true;}
	if(count($_SESSION["NGNIX_PRIVS"])>0){return true;}
	return false;

}